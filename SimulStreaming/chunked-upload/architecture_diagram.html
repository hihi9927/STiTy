<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STiTy 아키텍처 다이어그램</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
            font-family: 'Malgun Gothic', sans-serif;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        svg {
            width: 100%;
            height: auto;
            min-height: 1200px;
        }

        .box {
            fill: #FFF4E6;
            stroke: #FF9800;
            stroke-width: 2;
            rx: 10;
        }

        .box-header {
            fill: #FFE0B2;
            stroke: #FF9800;
            stroke-width: 2;
            rx: 10;
        }

        .layer-box {
            fill: none;
            stroke: #333;
            stroke-width: 3;
            stroke-dasharray: none;
            rx: 20;
        }

        .network-box {
            fill: #E8F5E9;
            stroke: #4CAF50;
            stroke-width: 2;
            rx: 10;
        }

        .backend-box {
            fill: #E3F2FD;
            stroke: #2196F3;
            stroke-width: 2;
            rx: 10;
        }

        .simul-box {
            fill: #F3E5F5;
            stroke: #9C27B0;
            stroke-width: 2;
            rx: 10;
        }

        .user-box {
            fill: #FFF9C4;
            stroke: #FBC02D;
            stroke-width: 2;
            rx: 15;
        }

        .arrow {
            stroke: #333;
            stroke-width: 2;
            fill: none;
            marker-end: url(#arrowhead);
        }

        .arrow-double {
            stroke: #4CAF50;
            stroke-width: 3;
            fill: none;
            marker-end: url(#arrowhead-green);
        }

        .text-title {
            font-size: 16px;
            font-weight: bold;
            fill: #333;
        }

        .text-content {
            font-size: 13px;
            fill: #555;
        }

        .text-small {
            font-size: 11px;
            fill: #666;
        }

        .text-label {
            font-size: 12px;
            fill: #2196F3;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #333; margin-bottom: 30px;">STiTy 시스템 아키텍처</h1>

        <svg viewBox="0 0 1400 1400" xmlns="http://www.w3.org/2000/svg">
            <!-- 화살표 마커 정의 -->
            <defs>
                <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#333" />
                </marker>
                <marker id="arrowhead-green" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                    <polygon points="0 0, 10 3, 0 6" fill="#4CAF50" />
                </marker>
            </defs>

            <!-- 사용자 -->
            <rect class="user-box" x="600" y="20" width="200" height="80" />
            <text class="text-title" x="700" y="50" text-anchor="middle">사용자</text>
            <text class="text-content" x="700" y="75" text-anchor="middle">(User)</text>

            <!-- 사용자에서 Layer 1로 화살표 -->
            <line class="arrow" x1="700" y1="100" x2="700" y2="150" />

            <!-- Layer 1: 프론트엔드 (Electron) -->
            <rect class="layer-box" x="100" y="150" width="600" height="520" />
            <text class="text-title" x="120" y="175" fill="#FF9800">Layer 1: 프론트엔드 (Electron)</text>

            <!-- Presentation Layer (UI) -->
            <rect class="box-header" x="150" y="200" width="500" height="140" />
            <text class="text-title" x="400" y="225" text-anchor="middle">Presentation Layer (UI)</text>
            <text class="text-content" x="170" y="250">• 투명 윈도우 (Always-on-Top)</text>
            <text class="text-content" x="170" y="275">• 자막 표시 (원문/번역)</text>
            <text class="text-content" x="170" y="300">• 그라데이션 상태 바</text>
            <text class="text-content" x="170" y="325">• 설정 창</text>

            <!-- 화살표 -->
            <line class="arrow" x1="400" y1="340" x2="400" y2="370" />

            <!-- Audio Capture Layer -->
            <rect class="box" x="150" y="370" width="500" height="140" />
            <text class="text-title" x="400" y="395" text-anchor="middle">Audio Capture Layer</text>
            <text class="text-content" x="170" y="420">• navigator.mediaDevices (마이크 접근 48kHz)</text>
            <text class="text-content" x="170" y="445">• AudioContext + ScriptProcessorNode</text>
            <text class="text-content" x="170" y="470">• 48kHz → 16kHz 다운샘플링</text>
            <text class="text-content" x="170" y="495">• Float32 → Int16 변환 후 전송</text>

            <!-- 화살표 -->
            <line class="arrow" x1="400" y1="510" x2="400" y2="540" />

            <!-- Communication Layer -->
            <rect class="box" x="150" y="540" width="500" height="100" />
            <text class="text-title" x="400" y="565" text-anchor="middle">Communication Layer</text>
            <text class="text-content" x="170" y="590">• WebSocket Client (양방향 통신)</text>
            <text class="text-content" x="170" y="615">• 자동 재연결</text>

            <!-- WebSocket 영역 -->
            <rect class="network-box" x="750" y="350" width="280" height="180" />
            <text class="text-title" x="890" y="375" text-anchor="middle">webSocket (WSS)</text>

            <text class="text-label" x="770" y="400" text-anchor="start">▲ Binary: PCM Int16 오디오 (16kHz)</text>
            <text class="text-small" x="770" y="420">• 클라이언트에서 다운샘플링</text>
            <text class="text-small" x="770" y="440">• 500ms 청크 (8000 샘플)</text>

            <text class="text-label" x="770" y="475" text-anchor="start">▼ JSON: 제어 메시지 / 결과</text>
            <text class="text-small" x="770" y="495">• hello, ready, final</text>
            <text class="text-small" x="770" y="515">• start, stop</text>

            <!-- Layer 1에서 WebSocket으로 화살표 -->
            <line class="arrow-double" x1="650" y1="590" x2="750" y2="450" />

            <!-- Layer 2: 백엔드 -->
            <rect class="layer-box" x="750" y="580" width="600" height="520" />
            <text class="text-title" x="770" y="605" fill="#2196F3">Layer 2: 백엔드 (Python FastAPI)</text>

            <!-- WebSocket Server -->
            <rect class="backend-box" x="800" y="630" width="500" height="80" />
            <text class="text-title" x="1050" y="655" text-anchor="middle">WebSocket Server</text>
            <text class="text-content" x="820" y="680">• /ws 엔드포인트</text>
            <text class="text-content" x="820" y="700">• 연결 관리 / 세션 생성</text>

            <!-- 화살표 -->
            <line class="arrow" x1="1050" y1="710" x2="1050" y2="740" />

            <!-- Audio Processing Pipeline -->
            <rect class="backend-box" x="800" y="740" width="500" height="140" />
            <text class="text-title" x="1050" y="765" text-anchor="middle">Audio Processing Pipeline</text>
            <text class="text-content" x="820" y="790">• PCM Int16 직접 수신 (FFmpeg 없음)</text>
            <text class="text-content" x="820" y="810">• numpy array 변환 (Int16 → Float32)</text>
            <text class="text-content" x="820" y="830">• 오디오 버퍼링</text>
            <text class="text-content" x="820" y="850">• 최소 청크 크기까지 누적</text>
            <text class="text-content" x="820" y="870">• online_asr_proc.insert_audio_chunk()</text>

            <!-- 화살표 -->
            <line class="arrow" x1="1050" y1="880" x2="1050" y2="910" />

            <!-- 화살표 - STT에서 응답으로 -->
            <line class="arrow" x1="1050" y1="1090" x2="1050" y2="1120" />

            <!-- STT & Translation -->
            <rect class="backend-box" x="800" y="910" width="500" height="180" />
            <text class="text-title" x="1050" y="935" text-anchor="middle">STT & Translation Engine</text>
            <text class="text-content" x="820" y="960">• AlignAtt 기반 SimulWhisper</text>
            <text class="text-content" x="840" y="980">- Cross-Attention 가중치 분석</text>
            <text class="text-content" x="840" y="1000">- 실시간 디코딩 (낮은 지연)</text>
            <text class="text-content" x="840" y="1020">- process_iter() 반복 호출</text>
            <text class="text-content" x="820" y="1045">• Google Translator</text>
            <text class="text-content" x="840" y="1065">- 한국어 ↔ 영어 양방향 번역</text>
            <text class="text-content" x="840" y="1085">- 텍스트 기반 언어 감지</text>

            <!-- WebSocket으로 돌아가는 화살표 -->
            <line class="arrow-double" x1="890" y1="530" x2="890" y2="630" />

            <!-- 응답에서 WebSocket으로 -->
            <line class="arrow" x1="950" y1="1120" x2="890" y2="530" stroke-dasharray="5,5" stroke="#2196F3" />


            <!-- 응답 박스 -->
            <rect class="backend-box" x="800" y="1120" width="500" height="100" />
            <text class="text-title" x="1050" y="1145" text-anchor="middle">WebSocket 응답</text>
            <text class="text-content" x="820" y="1170">• type: "final" (원문 + 번역)</text>
            <text class="text-content" x="820" y="1190">• start/end 타임스탬프 (ms)</text>
            <text class="text-content" x="820" y="1210">• ko, en 필드에 언어별 텍스트</text>

            <!-- Layer 3: 핵심 알고리즘 -->
            <rect class="layer-box" x="100" y="1270" width="500" height="120" />
            <text class="text-title" x="120" y="1295" fill="#9C27B0">핵심: AlignAtt 정책</text>

            <rect class="simul-box" x="150" y="1310" width="400" height="60" />
            <text class="text-content" x="170" y="1335">• Cross-Attention 가중치로 어디까지 디코딩할지 결정</text>
            <text class="text-content" x="170" y="1360">• 낮은 지연 + 높은 정확도 균형</text>

            <!-- 범례 -->
            <g transform="translate(700, 1270)">
                <text class="text-title" x="0" y="0">데이터 흐름:</text>

                <line class="arrow" x1="0" y1="20" x2="80" y2="20" />
                <text class="text-small" x="90" y="25">단방향 처리 흐름</text>

                <line class="arrow-double" x1="0" y1="45" x2="80" y2="45" />
                <text class="text-small" x="90" y="50">WebSocket 양방향 통신</text>

                <line class="arrow" x1="0" y1="70" x2="80" y2="70" stroke-dasharray="5,5" stroke="#2196F3" />
                <text class="text-small" x="90" y="75" fill="#2196F3">응답 흐름</text>

                <text class="text-title" x="0" y="110">주요 특징 (SimulStreaming):</text>
                <text class="text-small" x="0" y="130">• 클라이언트 다운샘플링 (48→16kHz)</text>
                <text class="text-small" x="0" y="150">• PCM Int16 직접 전송</text>
                <text class="text-small" x="0" y="170">• AlignAtt 실시간 디코딩</text>
                <text class="text-small" x="0" y="190">• 낮은 지연 + 높은 품질</text>
            </g>

        </svg>
    </div>
</body>
</html>